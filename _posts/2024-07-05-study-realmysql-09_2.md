---
title: 09. 옵티마이저와 힌트 - 스위치 옵션
description: 옵티마이저의 스위치 옵션의 종류
date: 2024-07-02 +0900
categories: [Study, Real MySQL 8.0]
tags: [Team Study, RealMySQL, optimizer]
---

## <b> 1. MRR 과 배치 키 액세스(MRR and Batch Key Access) </b>
- MRR 아닌 Nest Loop Join 방식
  - 드라이빙 테이블의 레코드를 읽고, 드리븐 테이블에서 일치하는 레코드 찾기
  - 조인처리는 MySQL 엔진이 처리하지만 데이터 조회는 스토리지 엔진에서 처리하는데, 건별로 레코드를 조회하는 이 조인 방식을 사용하게 되면 스토리지 엔진에서 최적화 하기 어려움
- MRR
  - Multi Range Read
  - 드라이빙 테이블의 레코드를 읽고 <b>조인 버퍼에 버퍼링</b> (즉, 즉시 조인하지 않고 조인 대상을 버퍼링)
  - 조인 버퍼가 가득 차면 스토리지 엔진에 한번에 요청
    - 조인 버퍼에는 key 로 정렬해서 저장
    - 디스크의 읽기 작업 최소화
- BKA
  - Batch Key Access
  - MRR 옵션을 활성화 할 때, 사용할 수 있는 알고리즘
  - default : "OFF"
    - 쿼리 특성마다 성능 차이가 있는 편임
    - 부가적인 정렬로 인한 성능 지연 가능성 존재

## <b> 2. 블록 네스티드 루프 조인 </b>
- 네스티드 루프 조인 
  - 조인의 연결 조건이 되는 컬럼에 모두 인덱스가 있는 경우
  - 수도코드로 표현하면 중첩 for 문과 유사함
  - 레코드를 읽는 과정에서 버퍼 사용하지 않음
- <b>블록</b>네스티드 루프 조인
  - 조인의 연결 조건에 인덱스가 없어서 테이블 풀 스캔을 하거나, 인덱스 풀 스캔을 해야하는 경우
  - 드라이빙 테이블에서 읽은 데이터를 조인 버퍼에 저장
  - 드리븐 테이블에서 데이터를 읽고 조인 버퍼의 데이터와 조인
- 유의할 점
  - 드라이빙과 드리븐 테이블의 조인 순서가 거꾸로인 것 처럼 느껴짐
    - 드라이빙 테이블의 조회 결과를 조인 버퍼에 저장하고
    - 드리븐 테이블의 조회 결과를 기준으로 조인 버퍼에서 일치하는 레코드를 찾음
    - 드리븐 테이블 데이터를 중심으로 결과를 만들기 때문에 정렬 결과가 흐트러질 수 있음 (보통 드라이빙 테이블의 정렬 순서대로 결과를 반환하지만 이 경우는 반대임)
  - MySQL 8.0 블록 네스티드 루프 대신 해시 조인 방식을 사용함
    - extra 에 Using Join Buffer 가 표시되지 않을 수 있음

## <b>3. 인덱스 푸시 다운</b>
- 쿼리에 사용되는 컬럼이 작업 범위 결정 조건, 필터 조건이라면 최대한 인덱스를 사용해서 데이터를 필터링하고 필요한 레코드만 테이블에서 읽는 방식
- extra 에 Using index condition 가 표시
- 인덱스 푸시 다운이 비활성화
  - 쿼리에 사용되는 컬럼들이 작업 범위 결정 조건, 필터 조건이 된다면
  - 작업 범위 조건까지는 인덱스를 사용하(스토리지 엔진)고 필터 조건에 해당하는 컬럼은 테이블을 접근해서 조건과 비교함(MySQL 엔진)
  - MySQL 5.5 에서는 작업 범위 제한 조건으로 사용되지 못하는 조건은 스토리지 엔진으로 전달하지 않았기 때문
  
## <b>4. 인덱스 확장</b>
- 세컨더리 인덱스를 사용할 때 프라이머리 키를 활용할지
- 인덱스를 확장해서 사용하면 아래와 같은 테이블에서 `name` 컬럼으로 세컨더리 인덱스를 생성한다면
- 옵티마이저가 실행계획을 분석할 때 (name, number) 를 세컨더리 인덱스로 보고 진행함
- 정렬, 작업 범위 결정 조건으로 활용되는 경우 쿼리 성능이 좋아짐
```sql
create table user
(
    number  varchar(255) primary key,
    name    varchar(255) not null,
    age     int          not null,
    created datetime(6)  not null,
    updated datetime(6)  not null
);
```

## <b>5. 인덱스 머지</b>
- 쿼리에 2개 이상의 인덱스를 사용해서 데이터를 조회하는 방식
- 결과를 병합하는 방식으로 구분
  - index_merge_intersection
  - index_merge_sort_union
  - index_merge_union
